import*as lpUtils from"../utils.js";import SweetAlert from"sweetalert2";import Sortable from"sortablejs";import Toastify from"toastify-js";import"toastify-js/src/toastify.css";import*as lpPopupSelectItemToAdd from"../lpPopupSelectItemToAdd.js";import*as editQuestion from"./edit-question.js";let elEditQuizWrap,elEditListQuestions;const className={elEditQuizWrap:".lp-edit-quiz-wrap",elQuestionEditMain:".lp-question-edit-main",elQuestionToggleAll:".lp-question-toggle-all",elEditListQuestions:".lp-edit-list-questions",elQuestionItem:".lp-question-item",elQuestionToggle:".lp-question-toggle",elPopupItemsToSelectClone:".lp-popup-items-to-select.clone",elBtnAddQuestion:".lp-btn-add-question",elBtnRemoveQuestion:".lp-btn-remove-question",elBtnUpdateQuestionTitle:".lp-btn-update-question-title",elBtnCancelUpdateQuestionTitle:".lp-btn-cancel-update-question-title",elQuestionTitleNewInput:".lp-question-title-new-input",elQuestionTitleInput:".lp-question-title-input",elQuestionTypeLabel:".lp-question-type-label",elQuestionTypeNew:".lp-question-type-new",elAddNewQuestion:"add-new-question",elQuestionClone:".lp-question-item.clone",LPTarget:".lp-target",elCollapse:"lp-collapse"};let quizID;const idUrlHandle="edit-quiz-questions",argsToastify={text:"",gravity:lpDataAdmin.toast.gravity,position:lpDataAdmin.toast.position,className:`${lpDataAdmin.toast.classPrefix}`,close:1==lpDataAdmin.toast.close,stopOnFocus:1==lpDataAdmin.toast.stopOnFocus,duration:lpDataAdmin.toast.duration},showToast=(e,t="success")=>{new Toastify({...argsToastify,text:e,className:`${lpDataAdmin.toast.classPrefix} ${t}`}).showToast()},toggleQuestionAll=(e,t)=>{const s=t.closest(`${className.elQuestionToggleAll}`);if(!s)return;const l=elEditQuizWrap.querySelectorAll(`${className.elQuestionItem}:not(.clone)`);s.classList.toggle(`${className.elCollapse}`),l.forEach(e=>{const t=s.classList.contains(`${className.elCollapse}`);e.classList.toggle(`${className.elCollapse}`,t)})},checkAllQuestionsCollapsed=()=>{const e=elEditQuizWrap.querySelectorAll(`${className.elQuestionItem}:not(.clone)`),t=elEditQuizWrap.querySelector(`${className.elQuestionToggleAll}`);let s=!0;e.forEach(e=>{if(e.classList.contains(`${className.elCollapse}`))return s=!1,!1}),s?t.classList.remove(`${className.elCollapse}`):t.classList.add(`${className.elCollapse}`)};let elPopupSelectItems;const updateCountItems=e=>{const t=elEditQuizWrap.querySelector(".total-items"),s=elEditQuizWrap.querySelectorAll(`${className.elQuestionItem}:not(.clone)`).length;t.dataset.count=s,t.querySelector(".count").textContent=s},addQuestion=(e,t)=>{let s=!1;if((t.closest(`${className.elBtnAddQuestion}`)||t.closest(`${className.elQuestionTitleNewInput}`)&&"Enter"===e.key)&&(s=!0),!s)return;e.preventDefault();const l=t.closest(`.${className.elAddNewQuestion}`);if(!l)return;const o=l.querySelector(`${className.elQuestionTitleNewInput}`),i=o.value.trim();if(!i)return void showToast(o.dataset.messEmptyTitle,"error");const n=l.querySelector(`${className.elQuestionTypeNew}`),a=n.value;if(!a)return void showToast(n.dataset.messEmptyType,"error");const u=elEditListQuestions.querySelector(`${className.elQuestionItem}.clone`),c=u.cloneNode(!0);c.querySelector(`${className.elQuestionTitleInput}`).value=i,o.value="",c.classList.remove("clone"),lpUtils.lpShowHideEl(c,1),u.insertAdjacentElement("beforebegin",c),lpUtils.lpSetLoadingEl(c,1);const r={success:e=>{const{message:t,status:s,data:l}=e,{question:o,html_edit_question:i}=l;if("error"===s)throw`Error: ${t}`;if("success"===s){c.dataset.questionId=o.ID,c.dataset.questionType=o.meta_data._lp_type,c.outerHTML=i;const e=elEditListQuestions.querySelector(`${className.elQuestionItem}[data-question-id="${o.ID}"]`);e.classList.remove(className.elCollapse),updateCountItems(),editQuestion.initTinyMCE();const t=e.querySelector(`${className.elQuestionEditMain}`);editQuestion.sortAbleQuestionAnswer(t)}showToast(t,s)},error:e=>{c.remove(),showToast(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(c,0),checkCanAddQuestion(e,o)}},d={action:"create_question_add_to_quiz",quiz_id:quizID,question_title:i,question_type:a,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(d,r)},checkCanAddQuestion=(e,t)=>{const s=t.closest(className.elQuestionTitleNewInput)||t.closest(className.elQuestionTypeNew);if(!s)return;const l=s.closest(`.${className.elAddNewQuestion}`);if(!l)return;const o=l.querySelector(`${className.elBtnAddQuestion}`);if(!o)return;const i=l.querySelector(`${className.elQuestionTitleNewInput}`),n=l.querySelector(`${className.elQuestionTypeNew}`),a=i.value.trim(),u=n.value;a&&u?o.classList.add("active"):o.classList.remove("active")},removeQuestion=(e,t)=>{const s=t.closest(`${className.elBtnRemoveQuestion}`);if(!s)return;const l=s.closest(`${className.elQuestionItem}`);if(!l)return;const o=l.dataset.questionId;SweetAlert.fire({title:s.dataset.title,text:s.dataset.content,icon:"warning",showCloseButton:!0,showCancelButton:!0,cancelButtonText:lpDataAdmin.i18n.cancel,confirmButtonText:lpDataAdmin.i18n.yes,reverseButtons:!0}).then(e=>{if(e.isConfirmed){lpUtils.lpSetLoadingEl(l,1);const e={success:e=>{const{message:t,status:s}=e;showToast(t,s),"success"===s&&(l.remove(),updateCountItems())},error:e=>{showToast(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(l,0)}},t={quiz_id:quizID,action:"remove_question_from_quiz",question_id:o,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(t,e)}})},updateQuestionTitle=(e,t)=>{let s=!1;if((t.closest(`${className.elBtnUpdateQuestionTitle}`)||t.closest(`${className.elQuestionTitleInput}`)&&"Enter"===e.key)&&(s=!0),!s)return;e.preventDefault();const l=t.closest(`${className.elQuestionItem}`);if(!l)return;const o=l.querySelector(`${className.elQuestionTitleInput}`);if(!o)return;const i=l.dataset.questionId,n=o.value.trim(),a=o.dataset.old,u=o.dataset.messEmptyTitle;if(0===n.length)return void showToast(u,"error");if(n===a)return;o.blur(),lpUtils.lpSetLoadingEl(l,1);const c={success:e=>{const{message:t,status:s}=e;"success"===s?o.dataset.old=n:o.value=a,showToast(t,s)},error:e=>{showToast(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(l,0),l.classList.remove("editing")}},r={quiz_id:quizID,action:"update_question",question_id:i,question_title:n,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(r,c)},changeTitleQuestion=(e,t)=>{const s=t.closest(`${className.elQuestionTitleInput}`);if(!s)return;const l=s.closest(`${className.elQuestionItem}`);s.value.trim()===(s.dataset.old||"")?l.classList.remove("editing"):l.classList.add("editing")},cancelChangeTitleQuestion=(e,t)=>{const s=t.closest(`${className.elBtnCancelUpdateQuestionTitle}`);if(!s)return;const l=s.closest(`${className.elQuestionItem}`),o=l.querySelector(`${className.elQuestionTitleInput}`);o.value=o.dataset.old||"",l.classList.remove("editing")},sortAbleQuestion=()=>{let e,t=0;new Sortable(elEditListQuestions,{handle:".drag",animation:150,onEnd:s=>{const l=s.item;t&&(clearTimeout(e),e=setTimeout(()=>{lpUtils.lpSetLoadingEl(l,1);const e=[];elEditListQuestions.querySelectorAll(`${className.elQuestionItem}:not(.clone)`).forEach(t=>{const s=t.dataset.questionId;s&&e.push(s)});const s={success:e=>{const{message:t,status:s}=e;if("success"!==s)throw`Error: ${t}`;showToast(t,s),editQuestion.initTinyMCE()},error:e=>{showToast(e,"error")},completed:()=>{lpUtils.lpSetLoadingEl(l,0),t=0}},o={quiz_id:quizID,action:"update_questions_position",question_ids:e,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(o,s)},1e3))},onMove:t=>{clearTimeout(e)},onUpdate:e=>{t=1}})};document.addEventListener("click",e=>{const t=e.target;toggleQuestionAll(0,t),lpUtils.toggleCollapse(e,t,className.elQuestionToggle,[],checkAllQuestionsCollapsed),addQuestion(e,t),removeQuestion(0,t),updateQuestionTitle(e,t),cancelChangeTitleQuestion(0,t);const s={willOpen:e=>{const t=elPopupSelectItems.querySelector(`${className.LPTarget}`),s=window.lpAJAXG.getDataSetCurrent(t);s.args.paged=1,s.args.item_selecting=e||[],window.lpAJAXG.setDataSetCurrent(t,s),window.lpAJAXG.showHideLoading(t,1),window.lpAJAXG.fetchAJAX(s,{success:e=>{const{data:s}=e;t.innerHTML=s.content||""},error:e=>{showToast(e,"error")},completed:()=>{window.lpAJAXG.showHideLoading(t,0),lpPopupSelectItemToAdd.watchItemsSelectedDataChange(elPopupSelectItems)}})}};lpPopupSelectItemToAdd.showPopupItemsToSelect(e,t,elPopupSelectItems,s),lpPopupSelectItemToAdd.selectItemsFromList(e,t,elPopupSelectItems),lpPopupSelectItemToAdd.addItemsSelectedToSection(e,t,elPopupSelectItems,e=>{const t=[];e.forEach(e=>{const s=elEditQuizWrap.querySelector(`${className.elQuestionItem}.clone`);if(!s)return;t.push(e.id);const l=s.cloneNode(!0),o=l.querySelector(`${className.elQuestionTitleInput}`);l.querySelector(`${className.elQuestionTypeLabel}`);l.classList.remove("clone"),l.dataset.questionId=e.id,o.value=e.titleSelected,lpUtils.lpSetLoadingEl(l,1),lpUtils.lpShowHideEl(l,1),s.insertAdjacentElement("beforebegin",l),lpUtils.lpSetLoadingEl(l,1)});const s={success:e=>{const{message:t,status:s,data:l}=e;if("success"!==s)throw`Error: ${t}`;{showToast(t,s);const{html_edit_question:e}=l;e&&Object.entries(e).forEach(([e,t])=>{elEditQuizWrap.querySelector(`${className.elQuestionItem}[data-question-id="${e}"]`).outerHTML=t}),updateCountItems(),editQuestion.initTinyMCE()}},error:e=>{showToast(e,"error")},completed:()=>{}},l={quiz_id:quizID,action:"add_questions_to_quiz",question_ids:t,args:{id_url:idUrlHandle}};window.lpAJAXG.fetchAJAX(l,s)}),lpPopupSelectItemToAdd.showItemsSelected(e,t,elPopupSelectItems),lpPopupSelectItemToAdd.backToSelectItems(e,t,elPopupSelectItems),lpPopupSelectItemToAdd.removeItemSelected(e,t,elPopupSelectItems)}),document.addEventListener("keydown",e=>{const t=e.target;"Enter"===e.key&&(updateQuestionTitle(e,t),addQuestion(e,t))}),document.addEventListener("keyup",e=>{const t=e.target;changeTitleQuestion(0,t),checkCanAddQuestion(e,t),lpPopupSelectItemToAdd.searchTitleItemToSelect(e,t,elPopupSelectItems)}),document.addEventListener("change",e=>{const t=e.target;checkCanAddQuestion(e,t)}),lpUtils.lpOnElementReady(`${className.elEditQuizWrap}`,e=>{elEditQuizWrap=e,elEditListQuestions=elEditQuizWrap.querySelector(`${className.elEditListQuestions}`);const t=elEditQuizWrap.closest(`${className.LPTarget}`),s=window.lpAJAXG.getDataSetCurrent(t);quizID=s.args.quiz_id;const l=elEditQuizWrap.querySelector(`${className.elPopupItemsToSelectClone}`);elPopupSelectItems=l.cloneNode(!0),elPopupSelectItems.classList.remove("clone","lp-hidden"),sortAbleQuestion(),editQuestion.events(),editQuestion.initTinyMCE();e.querySelectorAll(`${className.elQuestionEditMain}`).forEach(e=>{editQuestion.sortAbleQuestionAnswer(e)})});